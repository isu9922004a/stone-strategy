<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊòéÊòüÈ∫ªÂ∞á PWA</title>
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#062012">
    
    <!-- Scripts -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&display=swap');
        body { margin: 0; padding: 0; background-color: #062012; color: white; overflow: hidden; font-family: sans-serif; }
        .mahjong-font { font-family: 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Èò≤Ê≠¢ÊâãÊ©üÈï∑ÊåâÈÅ∏Âèñ */
        * { -webkit-touch-callout: none; -webkit-user-select: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Ê†∏ÂøÉÊºîÁÆóÊ≥ï ---
        class Mahjong16Solver {
            constructor() { this.HONOR_START = 27; this.memo = new Map(); }
            isWin(tiles) {
                if (tiles.length !== 17) return false;
                const sorted = [...tiles].sort((a, b) => a - b);
                const counts = new Array(34).fill(0);
                sorted.forEach(t => counts[t]++);
                this.memo.clear();
                for (let i = 0; i < 34; i++) {
                    if (counts[i] >= 2) {
                        const temp = [...counts];
                        temp[i] -= 2;
                        if (this._canFormMelds(temp)) return true;
                    }
                }
                return false;
            }
            _canFormMelds(counts) {
                const key = counts.join(',');
                if (this.memo.has(key)) return this.memo.get(key);
                let first = -1;
                for (let i = 0; i < 34; i++) { if (counts[i] > 0) { first = i; break; } }
                if (first === -1) return true;
                if (counts[first] >= 3) {
                    counts[first] -= 3;
                    if (this._canFormMelds(counts)) { counts[first] += 3; this.memo.set(key, true); return true; }
                    counts[first] += 3;
                }
                if (first < this.HONOR_START) {
                    const suitBase = Math.floor(first / 9) * 9;
                    if (first + 2 < suitBase + 9 && counts[first + 1] > 0 && counts[first + 2] > 0) {
                        counts[first]--; counts[first + 1]--; counts[first + 2]--;
                        if (this._canFormMelds(counts)) {
                            counts[first]++; counts[first + 1]++; counts[first + 2]++;
                            this.memo.set(key, true); return true;
                        }
                        counts[first]++; counts[first + 1]++; counts[first + 2]++;
                    }
                }
                this.memo.set(key, false); return false;
            }
        }

        // --- Â∏∏Êï∏ ---
        const TILE_SYMBOLS = ['üÄá','üÄà','üÄâ','üÄä','üÄã','üÄå','üÄç','üÄé','üÄè','üÄô','üÄö','üÄõ','üÄú','üÄù','üÄû','üÄü','üÄ†','üÄ°','üÄê','üÄë','üÄí','üÄì','üÄî','üÄï','üÄñ','üÄó','üÄò','üÄÄ','üÄÅ','üÄÇ','üÄÉ','üÄÑ','üÄÖ','üÄÜ'];
        const CHARACTERS = [
            { name: '‰Ω†', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Player', pitch: 1.0 },
            { name: 'ÊÜ≤Âì•', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix', pitch: 1.2, quotes: { discard: "Ë¶ãÈ¨ºÂï¶ÔºÅÈÄôÂºµÁµ¶‰Ω†", win: "ÊàëÊòØ Local KingÔºÅ" } },
            { name: '‰πÉÂì•', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka', pitch: 0.8, quotes: { discard: "Êàë‰∏çÈåÑ‰∫ÜÔºÅ", win: "ÈÄôÂ∞±ÊòØÂØ¶ÂäõÔºÅ" } },
            { name: 'ÁæéÈ≥≥Âßê', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Lily', pitch: 1.5, quotes: { discard: "ÈÄôÂºµÊ∞¥ÂñîÔΩû", win: "ÂìéÂëÄÔºå‰∏çÂ•ΩÊÑèÊÄùÔΩû" } }
        ];

        // --- ÁµÑ‰ª∂ ---
        const MahjongTile = ({ id, isSelected, onClick, isDiscard, isNew }) => {
            const isRed = id <= 8 || id === 31;
            return (
                <div onClick={onClick} className={`
                    bg-white rounded border border-gray-400 flex items-center justify-center cursor-pointer shadow-sm active:scale-95 transition-all
                    ${isSelected ? '-translate-y-2 ring-2 ring-yellow-400' : ''}
                    ${isDiscard ? 'w-6 h-9 text-lg md:w-8 md:h-12 md:text-2xl' : 'w-10 h-14 text-3xl md:w-11 md:h-16 md:text-4xl'}
                    ${isRed ? 'text-red-600' : 'text-green-800'} ${isNew ? 'border-blue-500' : ''} mahjong-font
                `} style={{ boxShadow: 'inset 0 -2px 0 #ccc' }}>
                    {TILE_SYMBOLS[id]}
                </div>
            );
        };

        const App = () => {
            const solver = useMemo(() => new Mahjong16Solver(), []);
            const [deck, setDeck] = useState([]);
            const [turn, setTurn] = useState(0);
            const [players, setPlayers] = useState(CHARACTERS.map((c, i) => ({ ...c, id: i, hand: [], discards: [] })));
            const [selectedIdx, setSelectedIdx] = useState(null);
            const [gameMsg, setGameMsg] = useState("Ê≠°Ëøé‰æÜÂà∞ÊòéÊòüÈ∫ªÂ∞áÔºÅ");

            const speak = (text, pitch = 1) => {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'zh-TW'; u.pitch = pitch;
                window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
            };

            const initGame = useCallback(() => {
                let d = []; for(let i=0; i<34; i++) for(let j=0; j<4; j++) d.push(i);
                d.sort(() => Math.random() - 0.5);
                const nextPlayers = CHARACTERS.map((c, i) => ({ ...c, id: i, hand: d.splice(0, 16).sort((a,b)=>a-b), discards: [] }));
                setDeck(d); setPlayers(nextPlayers); setTurn(0);
                drawTile(0, nextPlayers, d);
            }, []);

            const drawTile = (pIdx, curPlayers, curDeck) => {
                if (curDeck.length === 0) { setGameMsg("ÊµÅÂ±Ä‰∫ÜÔºÅ"); return; }
                const tile = curDeck[0];
                const nextDeck = curDeck.slice(1);
                const nextPlayers = [...curPlayers];
                nextPlayers[pIdx].hand.push(tile);
                setDeck(nextDeck); setPlayers(nextPlayers);
                if (pIdx !== 0) {
                    setTimeout(() => {
                        const idx = nextPlayers[pIdx].hand.length - 1;
                        handleDiscard(pIdx, idx, nextPlayers, nextDeck);
                    }, 1200);
                }
            };

            const handleDiscard = (pIdx, tileIdx, curPlayers, curDeck) => {
                const nextPlayers = [...curPlayers];
                const tile = nextPlayers[pIdx].hand.splice(tileIdx, 1)[0];
                nextPlayers[pIdx].discards.push(tile);
                nextPlayers[pIdx].hand.sort((a, b) => a - b);
                setPlayers(nextPlayers);
                if (pIdx !== 0 && nextPlayers[pIdx].quotes) speak(nextPlayers[pIdx].quotes.discard, nextPlayers[pIdx].pitch);
                const nextTurn = (pIdx + 1) % 4;
                setTurn(nextTurn);
                setTimeout(() => drawTile(nextTurn, nextPlayers, curDeck), 600);
            };

            useEffect(() => { initGame(); }, []);

            return (
                <div className="fixed inset-0 flex flex-col items-center justify-between p-4 pb-10">
                    <div className="w-full flex justify-between items-center px-4">
                        <div className="bg-black/40 px-3 py-1 rounded text-yellow-400">Ââ©È§ò: {deck.length}</div>
                        <button onClick={initGame} className="p-2 bg-white/10 rounded-full"><i data-lucide="refresh-cw"></i></button>
                    </div>

                    <div className="relative w-full max-w-lg aspect-square bg-[#144229] rounded-[40px] border-8 border-amber-900 shadow-2xl flex items-center justify-center">
                        <div className="text-white/10 font-black text-4xl">ÊòéÊòüÂ§ßÂ∞çÊ±∫</div>
                        <div className="absolute top-4 left-1/2 -translate-x-1/2 flex flex-col items-center">
                            <img src={players[2].avatar} className={`w-16 h-16 rounded-full border-2 ${turn===2?'border-yellow-400 scale-110':'border-white/20'}`} />
                            <span className="text-xs mt-1">{players[2].name}</span>
                        </div>
                        <div className="absolute left-4 top-1/2 -translate-y-1/2 flex flex-col items-center">
                            <img src={players[1].avatar} className={`w-16 h-16 rounded-full border-2 ${turn===1?'border-yellow-400 scale-110':'border-white/20'}`} />
                            <span className="text-xs mt-1">{players[1].name}</span>
                        </div>
                        <div className="absolute right-4 top-1/2 -translate-y-1/2 flex flex-col items-center">
                            <img src={players[3].avatar} className={`w-16 h-16 rounded-full border-2 ${turn===3?'border-yellow-400 scale-110':'border-white/20'}`} />
                            <span className="text-xs mt-1">{players[3].name}</span>
                        </div>
                        <div className="w-3/4 h-1/2 grid grid-cols-6 gap-1 p-2 overflow-hidden">
                            {players.flatMap(p => p.discards).map((t, i) => <MahjongTile key={i} id={t} isDiscard />)}
                        </div>
                    </div>

                    <div className="w-full max-w-2xl flex flex-col items-center gap-4">
                        <div className="bg-black/60 px-4 py-1 rounded-full text-xs text-white/80">{gameMsg}</div>
                        {turn === 0 && (
                            <div className="flex gap-4">
                                <button onClick={() => selectedIdx !== null && handleDiscard(0, selectedIdx, players, deck)} 
                                    className="bg-yellow-500 text-black px-6 py-2 rounded-full font-bold shadow-lg">Âá∫Áâå</button>
                                <button disabled={!solver.isWin(players[0].hand)} className="bg-red-600 px-6 py-2 rounded-full font-bold shadow-lg disabled:opacity-30">ËÉ°Áâå</button>
                            </div>
                        )}
                        <div className="flex gap-0.5 overflow-x-auto no-scrollbar w-full justify-center px-4">
                            {players[0].hand.map((id, i) => (
                                <MahjongTile key={i} id={id} isSelected={selectedIdx === i} 
                                    isNew={i === players[0].hand.length - 1 && players[0].hand.length === 17}
                                    onClick={() => turn === 0 && setSelectedIdx(i)} />
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setTimeout(() => lucide.createIcons(), 500);
    </script>
</body>
</html>

