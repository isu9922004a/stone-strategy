import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { Shield, Volume2, Settings, Trophy, Coins, MessageCircle } from 'lucide-react';

// ==========================================
// 1. æ ¸å¿ƒèƒ¡ç‰Œæ¼”ç®—æ³• (Mahjong16Solver)
// ==========================================
class Mahjong16Solver {
  constructor() {
    this.HONOR_START = 27;
    this.memo = new Map();
  }

  isWin(tiles) {
    if (tiles.length !== 17) return false;
    const sorted = [...tiles].sort((a, b) => a - b);
    const counts = this._toCounts(sorted);
    this.memo.clear();
    return this._isStandardWin(counts);
  }

  _toCounts(tiles) {
    const counts = new Array(34).fill(0);
    tiles.forEach(t => counts[t]++);
    return counts;
  }

  _isStandardWin(counts) {
    for (let i = 0; i < 34; i++) {
      if (counts[i] >= 2) {
        const temp = [...counts];
        temp[i] -= 2;
        if (this._canFormMelds(temp)) return true;
      }
    }
    return false;
  }

  _canFormMelds(counts) {
    const key = counts.join(',');
    if (this.memo.has(key)) return this.memo.get(key);
    let first = -1;
    for (let i = 0; i < 34; i++) {
      if (counts[i] > 0) { first = i; break; }
    }
    if (first === -1) return true;
    if (counts[first] >= 3) {
      counts[first] -= 3;
      if (this._canFormMelds(counts)) {
        counts[first] += 3;
        this.memo.set(key, true);
        return true;
      }
      counts[first] += 3;
    }
    if (first < this.HONOR_START) {
      const suitBase = Math.floor(first / 9) * 9;
      if (first + 2 < suitBase + 9 && counts[first + 1] > 0 && counts[first + 2] > 0) {
        counts[first]--; counts[first + 1]--; counts[first + 2]--;
        if (this._canFormMelds(counts)) {
          counts[first]++; counts[first + 1]++; counts[first + 2]++;
          this.memo.set(key, true);
          return true;
        }
        counts[first]++; counts[first + 1]++; counts[first + 2]++;
      }
    }
    this.memo.set(key, false);
    return false;
  }
}

// ==========================================
// 2. å¸¸æ•¸è¨­å®š
// ==========================================
const TILE_SYMBOLS = [
  'ğŸ€‡','ğŸ€ˆ','ğŸ€‰','ğŸ€Š','ğŸ€‹','ğŸ€Œ','ğŸ€','ğŸ€','ğŸ€', // è¬ 0-8
  'ğŸ€™','ğŸ€š','ğŸ€›','ğŸ€œ','ğŸ€','ğŸ€','ğŸ€Ÿ','ğŸ€ ','ğŸ€¡', // ç­’ 9-17
  'ğŸ€','ğŸ€‘','ğŸ€’','ğŸ€“','ğŸ€”','ğŸ€•','ğŸ€–','ğŸ€—','ğŸ€˜', // ç´¢ 18-26
  'ğŸ€€','ğŸ€','ğŸ€‚','ğŸ€ƒ','ğŸ€„','ğŸ€…','ğŸ€†'         // å­— 27-33
];

const CHARACTERS = [
  { name: 'ä½ ', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Player', pitch: 1.0 },
  { name: 'æ†²å“¥', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix', pitch: 1.2, quotes: { discard: "è¦‹é¬¼å•¦ï¼é€™å¼µçµ¦ä½ ", win: "æˆ‘æ˜¯ Local Kingï¼", draw: "æ‘¸ä¸€å¼µæ°´å–”ï¼" } },
  { name: 'ä¹ƒå“¥', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka', pitch: 0.8, quotes: { discard: "æˆ‘ä¸éŒ„äº†ï¼é€™å¼µæ‹¿å»", win: "é€™å°±æ˜¯å¯¦åŠ›ï¼", draw: "çµ‚æ–¼æ‘¸åˆ°äº†ã€‚" } },
  { name: 'ç¾é³³å§', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Lily', pitch: 1.5, quotes: { discard: "é€™å¼µæ°´å–”ï½", win: "å“å‘€ï¼ŒçœŸæ˜¯ä¸å¥½æ„æ€ï½", draw: "æ‰‹æ°£ä¸éŒ¯å‘¢ã€‚" } }
];

// ==========================================
// 3. èªéŸ³å¼•æ“
// ==========================================
const speak = (text, pitch = 1) => {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'zh-TW';
  utterance.pitch = pitch;
  utterance.rate = 1.1;
  window.speechSynthesis.speak(utterance);
};

// ==========================================
// 4. å­çµ„ä»¶
// ==========================================
const CelebAvatar = ({ player, isTurn, bubble, position }) => {
  const posStyles = {
    top: "top-4 left-1/2 -translate-x-1/2",
    left: "top-1/3 left-4",
    right: "top-1/3 right-4"
  };

  return (
    <div className={`absolute ${posStyles[position]} flex flex-col items-center z-30 transition-all duration-500`}>
      {bubble && (
        <div className="absolute -top-16 bg-white text-black px-4 py-2 rounded-2xl text-sm font-bold shadow-2xl animate-bounce border-2 border-slate-200 whitespace-nowrap after:content-[''] after:absolute after:top-full after:left-1/2 after:-translate-x-1/2 after:border-8 after:border-transparent after:border-t-white">
          {bubble}
        </div>
      )}
      <div className={`relative ${isTurn ? 'scale-110' : 'opacity-80 scale-95'}`}>
        <div className={`w-24 h-24 sm:w-28 sm:h-28 rounded-full border-4 ${isTurn ? 'border-yellow-400 shadow-[0_0_20px_rgba(250,204,21,0.6)]' : 'border-slate-400'} overflow-hidden bg-orange-100 shadow-xl transition-all`}>
          <img src={player.avatar} alt={player.name} className="w-full h-full object-cover" />
        </div>
        {isTurn && (
          <div className="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-red-600 text-white text-[10px] px-2 py-0.5 rounded-full animate-pulse font-black tracking-widest">
            THINKING
          </div>
        )}
      </div>
      <div className="mt-2 bg-black/70 backdrop-blur-sm px-4 py-1 rounded-full text-yellow-400 font-bold text-xs border border-yellow-900/50 shadow-lg">
        {player.name}
      </div>
    </div>
  );
};

const MahjongTile = ({ id, isSelected, onClick, isDiscard, isNew }) => {
  const isRed = id <= 8 || id === 31; // è¬å­èˆ‡ç´…ä¸­
  return (
    <div 
      onClick={onClick}
      className={`
        relative bg-white rounded-md flex items-center justify-center cursor-pointer transition-all
        ${isSelected ? '-translate-y-4 ring-4 ring-yellow-400 z-10' : 'hover:-translate-y-1 shadow-md'}
        ${isDiscard ? 'w-8 h-12 text-2xl' : 'w-11 h-16 text-4xl'}
        ${isRed ? 'text-rose-600' : 'text-emerald-700'}
        ${isNew ? 'animate-bounce border-blue-400' : 'border-slate-300'}
        font-serif font-bold border-2
      `}
      style={{ 
        boxShadow: 'inset 0 -4px 0 #e2e8f0, 2px 2px 4px rgba(0,0,0,0.2)',
        userSelect: 'none'
      }}
    >
      {TILE_SYMBOLS[id]}
    </div>
  );
};

// ==========================================
// 5. ä¸»ç¨‹å¼
// ==========================================
export default function App() {
  const solver = useMemo(() => new Mahjong16Solver(), []);
  const [deck, setDeck] = useState([]);
  const [turn, setTurn] = useState(0); // 0: Player, 1-3: NPCs
  const [players, setPlayers] = useState(CHARACTERS.map((c, i) => ({ ...c, id: i, hand: [], discards: [] })));
  const [bubbles, setBubbles] = useState({});
  const [selectedIdx, setSelectedIdx] = useState(null);
  const [gameMsg, setGameMsg] = useState("æ­¡è¿ä¾†åˆ°æ˜æ˜Ÿå¤§å°æ±ºï¼");
  const [lastDiscard, setLastDiscard] = useState(null);

  // åˆå§‹åŒ–éŠæˆ²
  const initGame = useCallback(() => {
    let newDeck = [];
    for (let i = 0; i < 34; i++) {
      for (let j = 0; j < 4; j++) newDeck.push(i);
    }
    newDeck.sort(() => Math.random() - 0.5);

    const newPlayers = [...players];
    for (let i = 0; i < 4; i++) {
      newPlayers[i].hand = newDeck.splice(0, 16).sort((a, b) => a - b);
      newPlayers[i].discards = [];
    }
    
    setDeck(newDeck);
    setPlayers(newPlayers);
    setTurn(0);
    drawTile(0, newPlayers, newDeck);
  }, []);

  useEffect(() => {
    initGame();
  }, []);

  // æ‘¸ç‰Œé‚è¼¯
  const drawTile = (pIdx, currentPlayers, currentDeck) => {
    if (currentDeck.length === 0) {
      setGameMsg("å¹³å±€ï¼ç‰Œæ‘¸å®Œäº†ã€‚");
      return;
    }
    const tile = currentDeck[0];
    const nextDeck = currentDeck.slice(1);
    const nextPlayers = [...currentPlayers];
    nextPlayers[pIdx].hand.push(tile);
    
    setDeck(nextDeck);
    setPlayers(nextPlayers);

    // æª¢æŸ¥æ‘¸ç‰Œå¾Œæ˜¯å¦èƒ¡ç‰Œ (åƒ…ç¤ºç¯„ç©å®¶æˆ–ç°¡å–®é‚è¼¯)
    if (solver.isWin(nextPlayers[pIdx].hand)) {
      handleWin(pIdx);
    } else {
      if (pIdx !== 0) {
        // AI è‡ªå‹•æ‰“ç‰Œ
        setTimeout(() => handleDiscard(pIdx, nextPlayers[pIdx].hand.length - 1), 1500);
      }
    }
  };

  // æ‰“ç‰Œé‚è¼¯
  const handleDiscard = (pIdx, tileIdx) => {
    const nextPlayers = [...players];
    const tile = nextPlayers[pIdx].hand.splice(tileIdx, 1)[0];
    nextPlayers[pIdx].discards.push(tile);
    nextPlayers[pIdx].hand.sort((a, b) => a - b);
    
    setLastDiscard(tile);
    setPlayers(nextPlayers);
    setSelectedIdx(null);

    // èªªè©±
    if (pIdx !== 0 && nextPlayers[pIdx].quotes) {
      const quote = nextPlayers[pIdx].quotes.discard;
      setBubbles({ [pIdx]: quote });
      speak(quote, nextPlayers[pIdx].pitch);
      setTimeout(() => setBubbles({}), 2000);
    }

    // æ›ä¸‹ä¸€ä½
    const nextTurn = (pIdx + 1) % 4;
    setTurn(nextTurn);
    setTimeout(() => drawTile(nextTurn, nextPlayers, deck), 500);
  };

  const handleWin = (pIdx) => {
    const winner = players[pIdx];
    setGameMsg(`${winner.name} èƒ¡ç‰Œäº†ï¼`);
    if (winner.quotes) {
      setBubbles({ [pIdx]: winner.quotes.win });
      speak(winner.quotes.win, winner.pitch);
    }
    setTurn(-1); // çµæŸ
  };

  return (
    <div className="w-full h-screen relative bg-[#062012] overflow-hidden font-sans select-none">
      
      {/* èƒŒæ™¯è£é£¾ï¼šåŸå¸‚å‰ªå½± */}
      <div className="absolute inset-0 pointer-events-none opacity-20">
        <div className="w-full h-full bg-gradient-to-b from-emerald-900 to-transparent flex items-end justify-around px-20">
          {[160, 240, 180, 300, 200].map((h, i) => (
            <div key={i} style={{ height: h }} className="w-24 bg-emerald-800/40 rounded-t-xl" />
          ))}
        </div>
      </div>

      {/* å·¦å³æœ¨è³ªé‚Šæ¡†æ¨¡æ“¬éŸ³éŸ¿ */}
      <div className="absolute left-0 top-0 w-12 h-full bg-gradient-to-r from-amber-950 to-amber-900 border-r-2 border-amber-800 flex flex-col items-center py-20 gap-8 shadow-2xl">
        <div className="w-6 h-6 rounded-full bg-black/80 shadow-inner" />
        <div className="w-6 h-6 rounded-full bg-black/80 shadow-inner" />
      </div>
      <div className="absolute right-0 top-0 w-12 h-full bg-gradient-to-l from-amber-950 to-amber-900 border-l-2 border-amber-800 flex flex-col items-center py-20 gap-8 shadow-2xl">
        <div className="w-6 h-6 rounded-full bg-black/80 shadow-inner" />
        <div className="w-6 h-6 rounded-full bg-black/80 shadow-inner" />
      </div>

      {/* ç‰Œæ¡Œä¸»é«” */}
      <div className="absolute inset-16 md:inset-24 bg-[#144229] rounded-[80px] border-[12px] border-amber-900 shadow-[0_0_80px_rgba(0,0,0,0.6)] overflow-hidden">
        <div className="absolute inset-0 border-2 border-emerald-400/10 rounded-[68px]"></div>
        
        {/* ä¸­é–“ LOGO & è³‡è¨Š */}
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center opacity-30">
          <Shield className="w-32 h-32 text-emerald-100" />
          <h2 className="text-emerald-100 font-black text-2xl tracking-[1em] mt-4">æ˜æ˜Ÿéº»å°‡</h2>
        </div>

        {/* NPC è§’è‰² */}
        <CelebAvatar player={players[2]} isTurn={turn === 2} bubble={bubbles[2]} position="top" />
        <CelebAvatar player={players[1]} isTurn={turn === 1} bubble={bubbles[1]} position="left" />
        <CelebAvatar player={players[3]} isTurn={turn === 3} bubble={bubbles[3]} position="right" />

        {/* å»¢ç‰Œæµ· (ä¸­é–“) */}
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3/5 h-2/5 flex flex-wrap content-center justify-center gap-1">
          {players.flatMap(p => p.discards).map((t, i) => (
            <MahjongTile key={i} id={t} isDiscard />
          ))}
        </div>
      </div>

      {/* åº•éƒ¨ UIï¼šç©å®¶æ§åˆ¶å€ */}
      <div className="absolute bottom-0 w-full h-40 flex flex-col items-center z-50">
        
        {/* è¨Šæ¯æç¤º */}
        <div className="bg-black/60 backdrop-blur-md px-6 py-1 rounded-full text-white text-sm mb-4 border border-white/10 animate-pulse">
          {gameMsg}
        </div>

        {/* å‹•ä½œæŒ‰éˆ• */}
        {turn === 0 && (
          <div className="flex gap-4 mb-4">
            <button 
              disabled={!solver.isWin(players[0].hand)}
              onClick={() => handleWin(0)}
              className="bg-red-600 hover:bg-red-500 disabled:bg-slate-700 text-white font-black px-8 py-2 rounded-full border-2 border-white shadow-xl transform active:scale-95 transition-all"
            >
              èƒ¡ç‰Œ
            </button>
            <button 
              onClick={() => selectedIdx !== null && handleDiscard(0, selectedIdx)}
              className="bg-yellow-500 hover:bg-yellow-400 text-amber-950 font-black px-8 py-2 rounded-full border-2 border-white shadow-xl transform active:scale-95 transition-all"
            >
              å‡ºç‰Œ
            </button>
          </div>
        )}

        {/* ç©å®¶æ‰‹ç‰Œ */}
        <div className="flex gap-0.5 px-8 py-4 bg-black/40 backdrop-blur-xl rounded-t-[40px] border-t-2 border-yellow-500/40 shadow-2xl">
          <div className="absolute left-6 top-1/2 -translate-y-1/2 flex items-center gap-3">
             <div className="w-12 h-12 rounded-full border-2 border-yellow-400 overflow-hidden bg-slate-200">
                <img src={players[0].avatar} className="w-full h-full object-cover" />
             </div>
             <div className="text-white">
                <p className="text-[10px] text-yellow-400 font-bold uppercase">Player</p>
                <div className="flex items-center gap-1">
                  <Coins className="w-3 h-3 text-yellow-500" />
                  <span className="text-sm font-bold tracking-tighter">99,850</span>
                </div>
             </div>
          </div>
          
          <div className="flex gap-0.5 ml-28">
            {players[0].hand.map((tileId, idx) => (
              <MahjongTile 
                key={`${tileId}-${idx}`} 
                id={tileId} 
                isSelected={selectedIdx === idx}
                isNew={idx === players[0].hand.length - 1 && players[0].hand.length === 17}
                onClick={() => turn === 0 && setSelectedIdx(idx)}
              />
            ))}
          </div>
        </div>
      </div>

      {/* å³ä¸Šè§’å·¥å…·åˆ— */}
      <div className="absolute top-6 right-8 flex gap-4 text-white z-50">
        <button onClick={initGame} className="w-10 h-10 rounded-full bg-black/40 flex items-center justify-center hover:bg-yellow-600 transition shadow-lg"><Settings className="w-5 h-5" /></button>
        <button className="w-10 h-10 rounded-full bg-black/40 flex items-center justify-center hover:bg-yellow-600 transition shadow-lg"><Trophy className="w-5 h-5" /></button>
        <button className="px-4 h-10 rounded-full bg-emerald-600 flex items-center gap-2 hover:bg-emerald-500 transition shadow-lg border border-white/20">
          <Coins className="w-4 h-4" />
          <span className="font-bold text-sm">å•†åº—</span>
        </button>
      </div>

      {/* å‰©é¤˜å¼µæ•¸æç¤º */}
      <div className="absolute top-6 left-16 bg-black/40 text-yellow-500 px-4 py-2 rounded-xl border border-white/10 backdrop-blur-sm">
        <p className="text-[10px] uppercase font-bold text-white/50">Deck Tiles</p>
        <p className="text-xl font-black">{deck.length}</p>
      </div>
    </div>
  );
}
