import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { Shield, Volume2, Settings, Trophy, Coins, MessageCircle, RefreshCw, Smartphone } from 'lucide-react';

/**
 * ==========================================
 * 1. æ ¸å¿ƒèƒ¡ç‰Œæ¼”ç®—æ³• (Mahjong16Solver)
 * ==========================================
 */
class Mahjong16Solver {
  constructor() {
    this.HONOR_START = 27;
    this.memo = new Map();
  }

  isWin(tiles) {
    if (tiles.length !== 17) return false;
    const sorted = [...tiles].sort((a, b) => a - b);
    const counts = this._toCounts(sorted);
    this.memo.clear();
    return this._isStandardWin(counts);
  }

  _toCounts(tiles) {
    const counts = new Array(34).fill(0);
    tiles.forEach(t => counts[t]++);
    return counts;
  }

  _isStandardWin(counts) {
    for (let i = 0; i < 34; i++) {
      if (counts[i] >= 2) {
        const temp = [...counts];
        temp[i] -= 2;
        if (this._canFormMelds(temp)) return true;
      }
    }
    return false;
  }

  _canFormMelds(counts) {
    const key = counts.join(',');
    if (this.memo.has(key)) return this.memo.get(key);
    let first = -1;
    for (let i = 0; i < 34; i++) {
      if (counts[i] > 0) { first = i; break; }
    }
    if (first === -1) return true;

    // åˆ»å­
    if (counts[first] >= 3) {
      counts[first] -= 3;
      if (this._canFormMelds(counts)) {
        counts[first] += 3;
        this.memo.set(key, true);
        return true;
      }
      counts[first] += 3;
    }

    // é †å­
    if (first < this.HONOR_START) {
      const suitBase = Math.floor(first / 9) * 9;
      if (first + 2 < suitBase + 9 && counts[first + 1] > 0 && counts[first + 2] > 0) {
        counts[first]--; counts[first + 1]--; counts[first + 2]--;
        if (this._canFormMelds(counts)) {
          counts[first]++; counts[first + 1]++; counts[first + 2]++;
          this.memo.set(key, true);
          return true;
        }
        counts[first]++; counts[first + 1]++; counts[first + 2]++;
      }
    }
    this.memo.set(key, false);
    return false;
  }
}

/**
 * ==========================================
 * 2. å¸¸æ•¸èˆ‡è³‡æº
 * ==========================================
 */
const TILE_SYMBOLS = [
  'ğŸ€‡','ğŸ€ˆ','ğŸ€‰','ğŸ€Š','ğŸ€‹','ğŸ€Œ','ğŸ€','ğŸ€','ğŸ€', // è¬ 0-8
  'ğŸ€™','ğŸ€š','ğŸ€›','ğŸ€œ','ğŸ€','ğŸ€','ğŸ€Ÿ','ğŸ€ ','ğŸ€¡', // ç­’ 9-17
  'ğŸ€','ğŸ€‘','ğŸ€’','ğŸ€“','ğŸ€”','ğŸ€•','ğŸ€–','ğŸ€—','ğŸ€˜', // ç´¢ 18-26
  'ğŸ€€','ğŸ€','ğŸ€‚','ğŸ€ƒ','ğŸ€„','ğŸ€…','ğŸ€†'         // å­— 27-33
];

const CHARACTERS = [
  { name: 'ä½ ', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Player', pitch: 1.0 },
  { name: 'æ†²å“¥', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix', pitch: 1.2, quotes: { discard: "è¦‹é¬¼å•¦ï¼é€™å¼µçµ¦ä½ ", win: "æˆ‘æ˜¯ Local Kingï¼", draw: "æ‘¸ä¸€å¼µæ°´å–”ï¼" } },
  { name: 'ä¹ƒå“¥', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka', pitch: 0.8, quotes: { discard: "æˆ‘ä¸éŒ„äº†ï¼é€™å¼µæ‹¿å»", win: "é€™å°±æ˜¯å¯¦åŠ›ï¼", draw: "çµ‚æ–¼æ‘¸åˆ°äº†ã€‚" } },
  { name: 'ç¾é³³å§', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Lily', pitch: 1.5, quotes: { discard: "é€™å¼µæ°´å–”ï½", win: "å“å‘€ï¼ŒçœŸæ˜¯ä¸å¥½æ„æ€ï½", draw: "æ‰‹æ°£ä¸éŒ¯å‘¢ã€‚" } }
];

const speak = (text, pitch = 1) => {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'zh-TW';
  utterance.pitch = pitch;
  utterance.rate = 1.2;
  window.speechSynthesis.speak(utterance);
};

/**
 * ==========================================
 * 3. å­çµ„ä»¶
 * ==========================================
 */
const CelebAvatar = ({ player, isTurn, bubble, position }) => {
  const posStyles = {
    top: "top-4 left-1/2 -translate-x-1/2",
    left: "top-1/4 left-4",
    right: "top-1/4 right-4"
  };

  return (
    <div className={`absolute ${posStyles[position]} flex flex-col items-center z-30 transition-all duration-500 scale-75 md:scale-100`}>
      {bubble && (
        <div className="absolute -top-12 bg-white text-black px-3 py-1 rounded-xl text-xs font-bold shadow-xl animate-bounce border-2 border-slate-200 whitespace-nowrap after:content-[''] after:absolute after:top-full after:left-1/2 after:-translate-x-1/2 after:border-4 after:border-transparent after:border-t-white">
          {bubble}
        </div>
      )}
      <div className={`relative ${isTurn ? 'scale-110' : 'opacity-80 scale-95'}`}>
        <div className={`w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 ${isTurn ? 'border-yellow-400 shadow-[0_0_15px_rgba(250,204,21,0.6)]' : 'border-slate-500/50'} overflow-hidden bg-orange-100 shadow-xl transition-all`}>
          <img src={player.avatar} alt={player.name} className="w-full h-full object-cover" />
        </div>
      </div>
      <div className="mt-1 bg-black/60 backdrop-blur-sm px-3 py-0.5 rounded-full text-yellow-400 font-bold text-[10px] border border-yellow-900/30">
        {player.name}
      </div>
    </div>
  );
};

const MahjongTile = ({ id, isSelected, onClick, isDiscard, isNew }) => {
  const isRed = id <= 8 || id === 31;
  return (
    <button 
      onClick={onClick}
      className={`
        relative bg-white rounded-sm flex items-center justify-center transition-all active:scale-95
        ${isSelected ? '-translate-y-3 ring-2 ring-yellow-400 z-10' : 'shadow-sm'}
        ${isDiscard ? 'w-6 h-9 md:w-8 md:h-12 text-xl md:text-2xl' : 'w-9 h-14 md:w-11 md:h-16 text-3xl md:text-4xl'}
        ${isRed ? 'text-rose-600' : 'text-emerald-700'}
        ${isNew ? 'border-blue-400 ring-1 ring-blue-200' : 'border-slate-300'}
        font-serif font-bold border
      `}
      style={{ 
        boxShadow: 'inset 0 -3px 0 #cbd5e1, 1px 1px 2px rgba(0,0,0,0.1)',
        touchAction: 'manipulation'
      }}
    >
      {TILE_SYMBOLS[id]}
    </button>
  );
};

/**
 * ==========================================
 * 4. PWA ç›¸é—œæ¨™ç±¤ (ç”¨æ–¼å‹•æ…‹æ³¨å…¥)
 * ==========================================
 */
const PWAMeta = () => (
  <>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#062012" />
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIuaYjuifp+m6u+WwhyBQV0EiLAogICJzaG9ydF9uYW1lIjogIuaYjuifp+m6u+WwhyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMDYyMDEyIiwKICAidGhlbWVfY29sb3IiOiAiIzA2MjAxMiIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vYXBpLmRpY2ViZWFyLmNvbS83LngvYXZhdGFhYXJzL3N2Zz9zZWVkPU1haGpvbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9" />
  </>
);

/**
 * ==========================================
 * 5. ä¸»ç¨‹å¼
 * ==========================================
 */
export default function App() {
  const solver = useMemo(() => new Mahjong16Solver(), []);
  const [deck, setDeck] = useState([]);
  const [turn, setTurn] = useState(0); 
  const [players, setPlayers] = useState(CHARACTERS.map((c, i) => ({ ...c, id: i, hand: [], discards: [] })));
  const [bubbles, setBubbles] = useState({});
  const [selectedIdx, setSelectedIdx] = useState(null);
  const [gameMsg, setGameMsg] = useState("æ­¡è¿ä¾†åˆ°æ˜æ˜Ÿå¤§å°æ±ºï¼");
  const [isGameOver, setIsGameOver] = useState(false);

  // åˆå§‹åŒ–éŠæˆ²
  const initGame = useCallback(() => {
    let newDeck = [];
    for (let i = 0; i < 34; i++) {
      for (let j = 0; j < 4; j++) newDeck.push(i);
    }
    newDeck.sort(() => Math.random() - 0.5);

    const newPlayers = CHARACTERS.map((c, i) => ({ 
      ...c, 
      id: i, 
      hand: newDeck.splice(0, 16).sort((a, b) => a - b),
      discards: [] 
    }));
    
    setDeck(newDeck);
    setPlayers(newPlayers);
    setTurn(0);
    setIsGameOver(false);
    setGameMsg("æ–°å±€é–‹å§‹ï¼Œç¥ä½ å¥½é‹ï¼");
    
    // ç¬¬ä¸€æ‰‹æ‘¸ç‰Œ
    drawTile(0, newPlayers, newDeck);
  }, []);

  useEffect(() => {
    initGame();
    // è¨»å†Š Service Worker æ¨¡æ“¬ (PWA å¿…è¦)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        console.log('PWA Ready');
      });
    }
  }, []);

  // æ‘¸ç‰Œé‚è¼¯
  const drawTile = (pIdx, currentPlayers, currentDeck) => {
    if (currentDeck.length === 0) {
      setGameMsg("å¹³å±€ï¼ç‰Œæ‘¸å®Œäº†ã€‚");
      setIsGameOver(true);
      return;
    }
    const tile = currentDeck[0];
    const nextDeck = currentDeck.slice(1);
    const nextPlayers = [...currentPlayers];
    nextPlayers[pIdx].hand.push(tile);
    
    setDeck(nextDeck);
    setPlayers(nextPlayers);

    // AI è‡ªå‹•æª¢æŸ¥èˆ‡å‡ºç‰Œ
    if (pIdx !== 0) {
      if (solver.isWin(nextPlayers[pIdx].hand)) {
        setTimeout(() => handleWin(pIdx), 1000);
      } else {
        setTimeout(() => handleDiscard(pIdx, nextPlayers[pIdx].hand.length - 1), 1500);
      }
    } else {
      setGameMsg("æ›ä½ æ‘¸ç‰Œäº†");
    }
  };

  // æ‰“ç‰Œé‚è¼¯
  const handleDiscard = (pIdx, tileIdx) => {
    if (isGameOver) return;
    const nextPlayers = [...players];
    const tile = nextPlayers[pIdx].hand.splice(tileIdx, 1)[0];
    nextPlayers[pIdx].discards.push(tile);
    nextPlayers[pIdx].hand.sort((a, b) => a - b);
    
    setPlayers(nextPlayers);
    setSelectedIdx(null);

    // AI èªªè©±
    if (pIdx !== 0 && nextPlayers[pIdx].quotes) {
      const quote = nextPlayers[pIdx].quotes.discard;
      setBubbles({ [pIdx]: quote });
      speak(quote, nextPlayers[pIdx].pitch);
      setTimeout(() => setBubbles({}), 1800);
    }

    const nextTurn = (pIdx + 1) % 4;
    setTurn(nextTurn);
    setTimeout(() => drawTile(nextTurn, nextPlayers, deck), 600);
  };

  const handleWin = (pIdx) => {
    const winner = players[pIdx];
    setGameMsg(`${winner.name} èƒ¡ç‰Œäº†ï¼`);
    setIsGameOver(true);
    if (winner.quotes) {
      setBubbles({ [pIdx]: winner.quotes.win });
      speak(winner.quotes.win, winner.pitch);
    }
    setTurn(-1);
  };

  return (
    <div className="fixed inset-0 bg-[#062012] overflow-hidden font-sans select-none flex flex-col items-center justify-center">
      <PWAMeta />

      {/* ç‰Œæ¡Œå€ */}
      <div className="relative w-[95vw] h-[70vh] md:w-[85vw] md:h-[75vh] bg-[#144229] rounded-[40px] md:rounded-[80px] border-[8px] md:border-[16px] border-amber-900 shadow-2xl flex items-center justify-center">
        
        {/* ä¸­å¿ƒè£é£¾ */}
        <div className="absolute opacity-10 flex flex-col items-center pointer-events-none">
          <Shield className="w-24 h-24 md:w-48 md:h-48 text-white" />
          <h1 className="text-white text-xl md:text-4xl font-black tracking-widest mt-4">æ˜æ˜Ÿéº»å°‡</h1>
        </div>

        {/* NPC ä½å…ƒ */}
        <CelebAvatar player={players[2]} isTurn={turn === 2} bubble={bubbles[2]} position="top" />
        <CelebAvatar player={players[1]} isTurn={turn === 1} bubble={bubbles[1]} position="left" />
        <CelebAvatar player={players[3]} isTurn={turn === 3} bubble={bubbles[3]} position="right" />

        {/* å»¢ç‰Œæµ· */}
        <div className="w-4/5 h-1/2 grid grid-cols-6 md:grid-cols-10 gap-1 p-4 overflow-hidden content-center justify-items-center opacity-90">
          {players.flatMap(p => p.discards).map((t, i) => (
            <MahjongTile key={i} id={t} isDiscard />
          ))}
        </div>

        {/* å‰©é¤˜å¼µæ•¸ */}
        <div className="absolute top-4 left-4 md:top-8 md:left-10 bg-black/40 text-yellow-500 px-3 py-1 rounded-lg border border-white/10">
          <span className="text-[10px] block opacity-50">TILES</span>
          <span className="text-lg font-bold leading-none">{deck.length}</span>
        </div>
      </div>

      {/* æ§åˆ¶å°èˆ‡æ‰‹ç‰Œ */}
      <div className="w-full max-w-5xl h-[25vh] flex flex-col items-center justify-end pb-4 space-y-3 z-40">
        
        {/* è¨Šæ¯æç¤º */}
        <div className="bg-black/40 backdrop-blur-sm px-4 py-1 rounded-full text-white text-xs border border-white/10 animate-pulse">
          {gameMsg}
        </div>

        {/* æŒ‰éˆ•å€ */}
        <div className="flex gap-4">
          {turn === 0 && !isGameOver && (
            <>
              <button 
                disabled={!solver.isWin(players[0].hand)}
                onClick={() => handleWin(0)}
                className="bg-red-600 hover:bg-red-500 disabled:opacity-30 text-white font-bold px-6 py-2 rounded-full shadow-lg border-2 border-white/20 active:scale-95 transition-all text-sm"
              >
                èƒ¡ç‰Œ
              </button>
              <button 
                disabled={selectedIdx === null}
                onClick={() => handleDiscard(0, selectedIdx)}
                className="bg-yellow-500 hover:bg-yellow-400 disabled:opacity-30 text-amber-950 font-bold px-6 py-2 rounded-full shadow-lg border-2 border-white/20 active:scale-95 transition-all text-sm"
              >
                å‡ºç‰Œ
              </button>
            </>
          )}
          {isGameOver && (
            <button 
              onClick={initGame}
              className="bg-emerald-600 hover:bg-emerald-500 text-white font-bold px-8 py-2 rounded-full shadow-lg border-2 border-white/20 flex items-center gap-2"
            >
              <RefreshCw size={18} /> å†ä¾†ä¸€å±€
            </button>
          )}
        </div>

        {/* æ‰‹ç‰Œå±•ç¤º */}
        <div className="w-full flex justify-center items-end px-2 overflow-x-auto no-scrollbar">
          <div className="flex gap-0.5 md:gap-1 pb-2">
            {players[0].hand.map((tileId, idx) => (
              <MahjongTile 
                key={`${tileId}-${idx}`} 
                id={tileId} 
                isSelected={selectedIdx === idx}
                isNew={idx === players[0].hand.length - 1 && players[0].hand.length === 17}
                onClick={() => turn === 0 && !isGameOver && setSelectedIdx(idx)}
              />
            ))}
          </div>
        </div>
      </div>

      {/* å·¥å…·æŒ‰éˆ• */}
      <div className="fixed top-4 right-4 flex gap-2">
        <button onClick={initGame} className="w-9 h-9 bg-white/10 rounded-full flex items-center justify-center text-white hover:bg-white/20"><Smartphone size={18} /></button>
        <button className="w-9 h-9 bg-white/10 rounded-full flex items-center justify-center text-white hover:bg-white/20"><Settings size={18} /></button>
      </div>

      <style dangerouslySetInnerHTML={{ __html: `
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `}} />
    </div>
  );
}

