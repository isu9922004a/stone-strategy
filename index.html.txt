<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çŸ³é ­ç²åˆ©åˆ†ææˆ°æ³• V2.1ï½œCDP+SAR+é–‹ç›¤åˆ¤å®š</title>
    <meta name="description" content="çŸ³é ­ç²åˆ©åˆ†ææˆ°æ³• - å°ˆç‚ºå°è‚¡ç•¶æ²–è¨­è¨ˆçš„ CDP èˆ‡ SAR é›™åˆ€æµåˆ†æå·¥å…·">
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* å°ç£è‚¡å¸‚é…è‰²é‚è¼¯ï¼šç´…æ¼²ç¶ è·Œ */
        .text-up { color: #ef4444; } /* Red-500 */
        .text-down { color: #22c55e; } /* Green-500 */
        .bg-up { background-color: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.4); }
        .bg-down { background-color: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.4); }
        .border-up { border-color: #ef4444; }
        .border-down { border-color: #22c55e; }
        
        /* åŸºç¤è¨­å®š */
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #0f172a; 
            color: #e2e8f0; 
            -webkit-font-smoothing: antialiased;
        }
        
        /* ç»ç’ƒæ“¬æ…‹é¢æ¿ */
        .glass-panel { 
            background: rgba(30, 41, 59, 0.75); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1); 
        }
        
        /* è¼¸å…¥æ¡†å„ªåŒ– */
        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        input:focus {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }

        /* å·è»¸ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fade-in">
        
        <!-- å·¦å´ï¼šè¼¸å…¥æ§åˆ¶å€ -->
        <div class="glass-panel p-6 rounded-2xl shadow-2xl flex flex-col gap-5">
            <!-- æ¨™é¡Œèˆ‡èªªæ˜æ›¸æŒ‰éˆ• -->
            <div class="flex justify-between items-center border-b border-gray-700 pb-4">
                <h1 class="text-2xl font-black text-gray-100 flex items-center gap-3">
                    <span class="w-3 h-8 bg-gradient-to-b from-red-500 to-red-700 rounded-sm shadow-lg shadow-red-500/30"></span>
                    çŸ³é ­ç²åˆ©åˆ†ææˆ°æ³•
                </h1>
                <button onclick="toggleModal(true)" class="flex items-center gap-1.5 text-xs font-bold bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1.5 rounded-lg transition-all border border-gray-600 hover:border-gray-500 shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                    ä½¿ç”¨èªªæ˜
                </button>
            </div>

            <!-- 0. è‚¡ç¥¨åç¨± -->
            <div class="relative">
                <label class="block text-xs font-bold text-yellow-500 mb-1 ml-1 uppercase tracking-wider">è‚¡ç¥¨ä»£è™Ÿ / åç¨± (å¿…å¡«)</label>
                <input type="text" id="stockSymbol" class="w-full bg-gray-900/50 border border-gray-600 focus:border-yellow-500 rounded-lg px-4 py-3 text-white outline-none font-bold text-lg placeholder-gray-600 transition-colors" placeholder="ä¾‹å¦‚ï¼šå°ç©é›» 2330">
            </div>
            
            <!-- 1. åŸºæº–æ•¸æ“š -->
            <div class="space-y-3">
                <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-gray-500"></span> 1. æ˜¨æ—¥åŸºæº– (Kæ£’æ•¸æ“š)
                </h2>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1 text-center">æœ€é«˜ (High)</label>
                        <input type="number" id="prevH" class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-2 text-white focus:border-red-500 outline-none text-center font-mono placeholder-gray-600 text-sm" placeholder="50.5" step="0.01">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1 text-center">æœ€ä½ (Low)</label>
                        <input type="number" id="prevL" class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-2 text-white focus:border-green-500 outline-none text-center font-mono placeholder-gray-600 text-sm" placeholder="48.0" step="0.01">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1 text-center">æ”¶ç›¤ (Close)</label>
                        <input type="number" id="prevC" class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-2 text-white focus:border-blue-500 outline-none text-center font-mono placeholder-gray-600 text-sm" placeholder="49.0" step="0.01">
                    </div>
                </div>
            </div>

            <!-- 2. ä»Šæ—¥é–‹ç›¤ -->
            <div class="space-y-2">
                <h2 class="text-sm font-bold text-blue-400 uppercase tracking-wider flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span> 2. ä»Šæ—¥é–‹ç›¤ (Open)
                </h2>
                <input type="number" id="todayOpen" class="w-full bg-gray-900/50 border border-blue-900/50 focus:border-blue-500 rounded-lg px-3 py-3 text-white text-xl font-bold text-center outline-none font-mono placeholder-gray-600 transition-colors" placeholder="ä»Šæ—¥é–‹ç›¤åƒ¹..." step="0.01">
            </div>

            <!-- 3. ç¾åƒ¹è¼¸å…¥ -->
            <div class="space-y-3 pt-2 border-t border-gray-700/50">
                <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-yellow-500"></span> 3. ç›®å‰æˆäº¤åƒ¹ (Price)
                </h2>
                <div class="relative group">
                    <input type="number" id="currP" class="w-full bg-gray-900 border-2 border-yellow-600/70 group-hover:border-yellow-500 rounded-xl px-4 py-4 text-4xl font-black text-white text-center shadow-[0_0_20px_rgba(234,179,8,0.1)] focus:shadow-[0_0_30px_rgba(234,179,8,0.2)] transition-all outline-none" placeholder="è¼¸å…¥ç¾åƒ¹..." step="0.01">
                    <div class="absolute right-5 top-1/2 -translate-y-1/2 text-gray-500 text-xs font-bold select-none border border-gray-700 px-2 py-1 rounded">TWD</div>
                </div>
                <button onclick="calculate()" class="w-full bg-gradient-to-r from-red-700 to-red-600 hover:from-red-600 hover:to-red-500 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg shadow-red-900/20 transform active:scale-[0.98] border border-red-500/30 flex items-center justify-center gap-2">
                    <span>ğŸš€</span> ç«‹å³åˆ†ææˆ°æƒ…
                </button>
                <div class="text-[10px] text-gray-500 text-center">è¼¸å…¥æ•¸å­—å¾ŒæŒ‰ <span class="px-1.5 py-0.5 bg-gray-800 rounded border border-gray-700 text-gray-300 font-mono">Enter</span> æˆ–é»æ“ŠæŒ‰éˆ•</div>
            </div>
            
             <!-- å¿«é€Ÿæ¨¡æ“¬ -->
             <div class="mt-2">
                <div class="flex gap-2">
                    <button onclick="simulatePrice('AH')" class="flex-1 py-2 bg-gray-800/50 hover:bg-red-900/30 text-[10px] text-gray-400 hover:text-red-300 rounded border border-gray-700 hover:border-red-500/30 transition-all">æ¨¡æ“¬çªç ´</button>
                    <button onclick="simulatePrice('CDP')" class="flex-1 py-2 bg-gray-800/50 hover:bg-yellow-900/30 text-[10px] text-gray-400 hover:text-yellow-300 rounded border border-gray-700 hover:border-yellow-500/30 transition-all">æ¨¡æ“¬ç›¤æ•´</button>
                    <button onclick="simulatePrice('AL')" class="flex-1 py-2 bg-gray-800/50 hover:bg-green-900/30 text-[10px] text-gray-400 hover:text-green-300 rounded border border-gray-700 hover:border-green-500/30 transition-all">æ¨¡æ“¬è·Œç ´</button>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šæˆ°æƒ…é¡¯ç¤ºæ¿ -->
        <div class="glass-panel p-0 rounded-2xl shadow-2xl overflow-hidden flex flex-col relative min-h-[600px] border-t-4 border-t-gray-700" id="resultPanel">
            <!-- Loading é®ç½© -->
            <div id="loadingOverlay" class="absolute inset-0 bg-gray-900/95 z-20 flex flex-col items-center justify-center text-center p-6 backdrop-blur-sm">
                <div class="w-16 h-1 bg-gradient-to-r from-transparent via-red-500 to-transparent mb-6 opacity-80 animate-pulse"></div>
                <h3 class="text-2xl font-black text-white mb-3">ç­‰å¾…æˆ°æƒ…æ•¸æ“š</h3>
                <p class="text-sm text-gray-400 leading-relaxed">è«‹åœ¨å·¦å´è¼¸å…¥å®Œæ•´è³‡è¨Š<br><span class="text-yellow-500/80">è‚¡ç¥¨ä»£è™Ÿ</span> â€¢ <span class="text-gray-500">æ˜¨æ—¥Kæ£’</span> â€¢ <span class="text-blue-400/80">é–‹ç›¤åƒ¹</span></p>
            </div>

            <!-- é ‚éƒ¨ï¼šé›™é‡å„€è¡¨ -->
            <div class="bg-gray-900/40 p-5 border-b border-gray-700/50 grid grid-cols-2 divide-x divide-gray-700/50">
                <!-- CDP ä¸»è¶¨å‹¢ -->
                <div class="text-center px-2 flex flex-col justify-center">
                    <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">CDP ä¸»è¶¨å‹¢</span>
                    <h2 id="trendText" class="text-2xl lg:text-3xl font-black mb-1 text-white tracking-tight leading-tight">---</h2>
                    <p id="trendDesc" class="text-[10px] lg:text-xs text-gray-400 font-medium">---</p>
                </div>
                
                <!-- SAR è¨Šè™Ÿ -->
                <div class="text-center px-4 flex flex-col items-center justify-center">
                    <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">SAR è¨Šè™Ÿ</span>
                    <div id="sarBox" class="w-full py-2.5 rounded-lg border border-gray-700 bg-gray-800/50 transition-all">
                        <div id="sarSignalText" class="text-xl font-black text-gray-500">WAIT</div>
                        <div id="sarPriceText" class="text-[10px] text-gray-400 font-mono mt-0.5 opacity-80">é˜²å®ˆ: ---</div>
                    </div>
                </div>
            </div>

            <!-- Kæ£’ç‹€æ…‹æ¢ -->
            <div class="bg-gray-800/30 px-5 py-3 border-b border-gray-700/50 flex justify-between items-center text-xs">
                <div class="text-gray-400 font-medium">K æ£’åŠ›é“ï¼š</div>
                <div id="kBarStatus" class="font-bold text-gray-500 font-mono">---</div>
            </div>

            <!-- æ“ä½œå»ºè­° -->
            <div class="p-5 grid grid-cols-2 gap-4 bg-gray-900/20">
                <div class="text-center p-3 rounded-xl border border-red-500/20 bg-red-500/5 backdrop-blur-sm">
                    <div class="text-[10px] text-red-400/70 mb-1 uppercase tracking-wider font-bold">é˜²å®ˆ / åŠ ç¢¼é»</div>
                    <div id="buyPoint" class="text-base font-bold text-red-400">---</div>
                </div>
                <div class="text-center p-3 rounded-xl border border-green-500/20 bg-green-500/5 backdrop-blur-sm">
                    <div class="text-[10px] text-green-400/70 mb-1 uppercase tracking-wider font-bold">å£“åŠ› / ç²åˆ©é»</div>
                    <div id="sellPoint" class="text-base font-bold text-green-400">---</div>
                </div>
            </div>

            <!-- CDP éšæ¢¯è¡¨ -->
            <div class="flex-1 px-5 pb-4 overflow-y-auto">
                <table class="w-full text-sm border-separate border-spacing-y-1">
                    <thead>
                        <tr class="text-gray-500 text-left text-[10px] uppercase tracking-wider">
                            <th class="pb-2 pl-2">CDP é—œå¡</th>
                            <th class="pb-2 text-right">åƒ¹æ ¼</th>
                            <th class="pb-2 text-right pr-2">ä½ç½®</th>
                        </tr>
                    </thead>
                    <tbody id="cdpTable" class="font-mono">
                        <!-- JS ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>

            <!-- çµè«–å€ -->
            <div class="bg-gray-900/80 p-5 border-t border-gray-700 backdrop-blur-md">
                 <div class="flex justify-between items-center mb-3">
                     <h3 class="text-xs font-bold text-gray-400 flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-yellow-500 rounded-full animate-pulse"></span>
                        çŸ³é ­æˆ°æ³•æ¥µé€Ÿæ–‡ç¨¿
                     </h3>
                     <div class="flex gap-2">
                        <button onclick="copyScript()" id="copyBtn" class="group text-xs bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1.5 rounded-md transition-all flex items-center gap-1.5 border border-gray-600 hover:border-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 group-hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            è¤‡è£½å…¨æ–‡
                        </button>
                     </div>
                 </div>
                 <textarea id="outputScript" rows="5" class="w-full bg-black/40 border border-gray-700 rounded-lg p-3 text-xs text-gray-300 outline-none resize-none font-sans focus:border-gray-500 transition-colors leading-relaxed" readonly></textarea>
            </div>
        </div>
    </div>

    <!-- èªªæ˜æ›¸ Modal -->
    <div id="instructionModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-gray-900 border border-gray-600 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl relative transform transition-transform duration-300 scale-95">
            
            <button onclick="toggleModal(false)" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors bg-gray-800 rounded-full p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <div class="p-8">
                <h2 class="text-2xl font-black text-white mb-8 flex items-center gap-3 border-b border-gray-800 pb-4">
                    <span class="text-3xl">ğŸ“–</span> çŸ³é ­æˆ°æ³•æ“ä½œæ‰‹å†Š
                </h2>

                <div class="space-y-8 text-gray-300">
                    
                    <section>
                        <h3 class="text-base font-bold text-yellow-500 mb-3 flex items-center gap-2">
                            <span class="w-1 h-4 bg-yellow-500 rounded-full"></span> 1. æ•¸æ“šæº–å‚™ (å¿…å¡«)
                        </h3>
                        <ul class="ml-4 space-y-2 text-sm text-gray-400">
                            <li><strong class="text-gray-200">æ˜¨æ—¥ K æ£’ (H/L/C)ï¼š</strong>é€™æ˜¯åœ°åœ–ã€‚æ±ºå®šä»Šæ—¥çš„æ”¯æ’èˆ‡å£“åŠ›ä½ç½®ã€‚</li>
                            <li><strong class="text-gray-200">ä»Šæ—¥é–‹ç›¤ (Open)ï¼š</strong>é€™æ˜¯åŸºæº–ã€‚æ±ºå®šä»Šæ—¥å¤šç©ºä¸»åŠ›æ˜¯èª° (ç´…Kä¸»åŠ›è²·/é»‘Kä¸»åŠ›è³£)ã€‚</li>
                        </ul>
                    </section>

                    <section>
                        <h3 class="text-base font-bold text-blue-400 mb-3 flex items-center gap-2">
                            <span class="w-1 h-4 bg-blue-400 rounded-full"></span> 2. ä¸‰ä½ä¸€é«”åˆ¤è®€
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                <div class="font-bold text-yellow-500 mb-1">CDP (é—œå¡)</div>
                                <div class="text-xs text-gray-400">AH/NH æ˜¯å£“åŠ›ï¼ŒNL/AL æ˜¯æ”¯æ’ã€‚åˆ¤æ–·è‚¡åƒ¹ä½æ–¼é«˜æª”é‚„æ˜¯ä½æª”ã€‚</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                <div class="font-bold text-red-400 mb-1">SAR (è¶¨å‹¢)</div>
                                <div class="text-xs text-gray-400">ç´…ç‡ˆåšå¤šï¼Œç¶ ç‡ˆåšç©ºã€‚é€™æ˜¯ç§»å‹•åœæé»ï¼Œä¹Ÿæ˜¯å¤§æ–¹å‘ã€‚</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                <div class="font-bold text-green-400 mb-1">K æ£’ (åŠ›é“)</div>
                                <div class="text-xs text-gray-400">å¯¦é«”ç´…Kä»£è¡¨ä¸»åŠ›è²·é€²ï¼Œå¯¦é«”é»‘Kä»£è¡¨ä¸»åŠ›å€’è²¨ã€‚</div>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-base font-bold text-green-400 mb-3 flex items-center gap-2">
                            <span class="w-1 h-4 bg-green-400 rounded-full"></span> 3. å¯¦æˆ°å¿…å‹å£è¨£
                        </h3>
                        <div class="space-y-3">
                            <div class="bg-red-500/10 border border-red-500/30 p-4 rounded-xl flex gap-3 items-start">
                                <span class="text-2xl">ğŸ”¥</span>
                                <div>
                                    <h4 class="font-bold text-red-400">é›™ç´…å…±æŒ¯ (æœ€å¼·è²·é»)</h4>
                                    <p class="text-xs mt-1 text-gray-400">SAR äº®ç´…ç‡ˆ + å¯¦é«”ç´… Kã€‚å›æ¸¬ CDP æ”¯æ’ä¸ç ´ï¼Œå¤§è†½è²·é€²ã€‚</p>
                                </div>
                            </div>
                            <div class="bg-green-500/10 border border-green-500/30 p-4 rounded-xl flex gap-3 items-start">
                                <span class="text-2xl">ğŸ“‰</span>
                                <div>
                                    <h4 class="font-bold text-green-400">é›™ç¶ å…±æŒ¯ (æœ€å¼·ç©ºé»)</h4>
                                    <p class="text-xs mt-1 text-gray-400">SAR äº®ç¶ ç‡ˆ + å¯¦é«”é»‘ Kã€‚åå½ˆ CDP å£“åŠ›ä¸éï¼Œå¤§è†½æ”¾ç©ºã€‚</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
                
                <div class="mt-8 pt-6 border-t border-gray-800 text-center">
                    <button onclick="toggleModal(false)" class="bg-gray-800 hover:bg-gray-700 text-white px-8 py-2 rounded-lg text-sm font-bold transition-colors">æˆ‘ç­è§£äº†</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Modal Logic
        const modal = document.getElementById('instructionModal');
        const modalContent = modal.querySelector('div');

        function toggleModal(show) {
            if (show) {
                modal.classList.remove('hidden');
                // Small timeout to allow display:block to apply before opacity transition
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modalContent.classList.remove('scale-95');
                    modalContent.classList.add('scale-100');
                }, 10);
            } else {
                modal.classList.add('opacity-0');
                modalContent.classList.remove('scale-100');
                modalContent.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        modal.addEventListener('click', function(e) {
            if (e.target === this) toggleModal(false);
        });

        // Demo Data
        document.getElementById('prevH').value = 50.5;
        document.getElementById('prevL').value = 48.0;
        document.getElementById('prevC').value = 49.0;
        document.getElementById('todayOpen').value = 49.2;
        
        // Enter Key Listener
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') calculate();
            });
        });

        // Simulation
        let levels = {};
        function simulatePrice(type) {
            const H = parseFloat(document.getElementById('prevH').value);
            if(isNaN(H)) { calculate(); return; } // Force basic calc to get levels if not exists
            if(!levels.CDP) {
                 const L = parseFloat(document.getElementById('prevL').value);
                 const C = parseFloat(document.getElementById('prevC').value);
                 if(isNaN(H) || isNaN(L) || isNaN(C)) return;
                 // Quick Calc for Sim
                 const cdp = (H + L + (2 * C)) / 4;
                 levels = { 
                     AH: cdp + (H - L), 
                     NH: (2 * cdp) - L, 
                     CDP: cdp, 
                     NL: (2 * cdp) - H, 
                     AL: cdp - (H - L) 
                 };
            }
            
            let p = 0;
            const noise = (Math.random() * 0.1).toFixed(2);
            if (type === 'AH') p = levels.AH + parseFloat(noise);
            if (type === 'CDP') p = levels.CDP + parseFloat(noise);
            if (type === 'AL') p = levels.AL - parseFloat(noise);
            document.getElementById('currP').value = p.toFixed(2);
            calculate();
        }

        // Core Calc
        function calculateSAR(prevH, prevL, prevC) {
            const AF = 0.02;
            const mid = (prevH + prevL) / 2;
            const isUptrend = prevC >= mid;
            return isUptrend ? (prevL + AF * (prevH - prevL)) : (prevH - AF * (prevH - prevL));
        }

        function calculate() {
            const H = parseFloat(document.getElementById('prevH').value);
            const L = parseFloat(document.getElementById('prevL').value);
            const C = parseFloat(document.getElementById('prevC').value);
            const P = parseFloat(document.getElementById('currP').value);
            const Open = parseFloat(document.getElementById('todayOpen').value); 
            let StockName = document.getElementById('stockSymbol').value.trim();
            if (!StockName) StockName = "æ¨™çš„";

            if (isNaN(H) || isNaN(L) || isNaN(C) || isNaN(P) || isNaN(Open)) {
                alert("è«‹å®Œæ•´è¼¸å…¥æ‰€æœ‰æ¬„ä½æ•¸å€¼");
                return;
            }

            // UI Transition
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('opacity-0');
            setTimeout(() => overlay.classList.add('hidden'), 300);
            
            document.getElementById('resultPanel').classList.remove('border-t-gray-700');
            document.getElementById('resultPanel').classList.add('border-t-yellow-500'); // Active state indication

            // CDP Calc
            const CDP = (H + L + (2 * C)) / 4;
            const AH = CDP + (H - L);
            const NH = (2 * CDP) - L;
            const NL = (2 * CDP) - H;
            const AL = CDP - (H - L);
            levels = { AH, NH, CDP, NL, AL };

            // SAR Calc
            const sarVal = calculateSAR(H, L, C);
            const sarSignal = P > sarVal ? "LONG" : "SHORT";

            // K-Bar Logic
            const isRedK = P > Open;
            const diff = Math.abs(P - Open).toFixed(2);
            const kStatusText = isRedK ? 
                `ğŸ”¥ å¯¦é«”ç´… K (æ¼² ${diff})` : 
                (P < Open ? `ğŸ¥¶ å¯¦é«”é»‘ K (è·Œ ${diff})` : `âšª åå­—ç·š (å¹³ç›¤)`);
            const kStatusColor = isRedK ? "text-red-400" : (P < Open ? "text-green-400" : "text-gray-400");
            
            // Update K-Bar UI
            const kBarEl = document.getElementById('kBarStatus');
            kBarEl.innerText = kStatusText;
            kBarEl.className = `font-bold font-mono text-sm ${kStatusColor}`;

            // Trend Logic
            let trend = "", trendClass = "", trendDesc = "", buySuggest = "", sellSuggest = "", strategyText = ""; 
            
            if (P >= AH) {
                trend = "ğŸ”¥ æ¥µå¼·å¤šé ­"; trendClass = "text-up"; trendDesc = "çªç ´è¿½åƒ¹ï¼Œè¶¨å‹¢å™´å‡º";
                buySuggest = `å®ˆç©© ${AH.toFixed(2)} çºŒæŠ±`; sellSuggest = "ä¸é è¨­é«˜é»";
                strategyText = `å¼·å‹¢çªç ´ AH (${AH.toFixed(2)})ï¼Œä¸Šæ–¹ç„¡å£“åŠ›ï¼Œåš´ç¦åšç©ºï¼ŒæŒå¤šå–®è€…è¨­ ${AH.toFixed(2)} ç‚ºé˜²å®ˆã€‚`;
            } else if (P >= NH) {
                trend = "ğŸ“ˆ åå¼·å¤šæ–¹"; trendClass = "text-up"; trendDesc = "å¤šæ–¹æ§ç›¤ï¼Œæ¸¬è©¦å‰é«˜";
                buySuggest = `å›æ¸¬ ${NH.toFixed(2)} ä¸ç ´`; sellSuggest = `${AH.toFixed(2)} é™„è¿‘èª¿ç¯€`;
                strategyText = `ä½æ–¼ NH-AH ä¹‹é–“ï¼Œå¤šæ–¹å¼·å‹¢ã€‚æ¥è¿‘ ${AH.toFixed(2)} å¯åˆ†æ‰¹ç²åˆ©ï¼Œæ‹‰å› ${NH.toFixed(2)} ä¸ç ´å¯åŠ ç¢¼ã€‚`;
            } else if (P >= CDP) {
                trend = "ğŸ‚ ç›¤æ•´åå¤š"; trendClass = "text-yellow-400"; trendDesc = "å¤šç©ºå¹³è¡¡ï¼Œç•¥ä½”å„ªå‹¢";
                buySuggest = `${CDP.toFixed(2)} é™„è¿‘ä½æ¥`; sellSuggest = `${NH.toFixed(2)} é‡å£“è³£å‡º`;
                strategyText = `åœ¨ CDP ä¹‹ä¸Šï¼Œå±¬å¤šæ–¹æ•´ç†ã€‚å»ºè­°åœ¨ CDP (${CDP.toFixed(2)}) é™„è¿‘å°‹æ‰¾è²·é»ï¼Œç›®æ¨™çœ‹ ${NH.toFixed(2)}ã€‚`;
            } else if (P >= NL) {
                trend = "ğŸ» ç›¤æ•´åç©º"; trendClass = "text-yellow-500"; trendDesc = "å¼±å‹¢æ•´ç†ï¼Œåå½ˆç„¡åŠ›";
                buySuggest = `${NL.toFixed(2)} æœ‰æ’æ¶çŸ­`; sellSuggest = `${CDP.toFixed(2)} ç«™ä¸ä¸Šç©º`;
                strategyText = `è·Œç ´ CDPï¼Œå¼±å‹¢æ•´ç†ã€‚åå½ˆè‡³ CDP (${CDP.toFixed(2)}) ä¸éå»ºè­°æ¸›ç¢¼æˆ–è©¦ç©ºã€‚`;
            } else if (P >= AL) {
                trend = "ğŸ“‰ åå¼±ç©ºæ–¹"; trendClass = "text-down"; trendDesc = "ç©ºæ–¹æ§ç›¤ï¼Œå°‹æ±‚æ”¯æ’";
                buySuggest = `${AL.toFixed(2)} é™„è¿‘è§€å¯Ÿ`; sellSuggest = `${NL.toFixed(2)} ä»¥å‰é›¢å ´`;
                strategyText = `å£“åœ¨ NL ä¹‹ä¸‹ï¼Œç©ºæ–¹åŠ›é“å¼·ã€‚è‹¥è·Œç ´ ${AL.toFixed(2)} æå¼•ç™¼æ®ºç›¤ï¼Œå¤šå–®æ‡‰åš´æ ¼åœæã€‚`;
            } else {
                trend = "ğŸ§Š æ¥µå¼±ç©ºé ­"; trendClass = "text-down"; trendDesc = "è¶…è·Œå€åŸŸï¼Œæ…é˜²å¤šæ®ºå¤š";
                buySuggest = "æš«ä¸æ¥åˆ€ (å¾…æ­¢è·Œ)"; sellSuggest = `åå½ˆ ${AL.toFixed(2)} é€ƒå‘½`;
                strategyText = `å·²è·Œç ´ AL (${AL.toFixed(2)})ï¼Œé€²å…¥è¶…è³£å€ï¼Œåˆ‡å‹¿ç›²ç›®æŠ„åº•ï¼Œéœ€ç­‰å¾…å‡ºé‡æ­¢è·Œè¨Šè™Ÿã€‚`;
            }

            // Update Dashboards
            const tText = document.getElementById('trendText');
            tText.innerText = trend;
            tText.className = `text-2xl lg:text-3xl font-black mb-1 tracking-tight leading-tight ${trendClass}`;
            document.getElementById('trendDesc').innerText = trendDesc;
            document.getElementById('buyPoint').innerText = buySuggest;
            document.getElementById('sellPoint').innerText = sellSuggest;

            // Update SAR UI
            const sarBox = document.getElementById('sarBox');
            const sarSigText = document.getElementById('sarSignalText');
            const sarPText = document.getElementById('sarPriceText');
            sarPText.innerText = `é˜²å®ˆåƒ¹: ${sarVal.toFixed(2)}`;
            
            if(sarSignal === "LONG") {
                sarBox.className = "w-full py-2.5 rounded-lg border border-red-500/50 bg-red-900/20 transition-all shadow-[0_0_15px_rgba(239,68,68,0.2)]";
                sarSigText.innerHTML = "ğŸ”´ å¤š (LONG)";
                sarSigText.className = "text-2xl font-black text-red-500";
            } else {
                sarBox.className = "w-full py-2.5 rounded-lg border border-green-500/50 bg-green-900/20 transition-all shadow-[0_0_15px_rgba(34,197,94,0.2)]";
                sarSigText.innerHTML = "ğŸŸ¢ ç©º (SHORT)";
                sarSigText.className = "text-2xl font-black text-green-500";
            }

            // Generate Table
            const tableBody = document.getElementById('cdpTable');
            tableBody.innerHTML = '';
            
            const renderRow = (name, val, label) => {
                const isCurrentZone = (name === 'AH' && P >= AH) ||
                                      (name === 'NH' && P >= NH && P < AH) ||
                                      (name === 'CDP' && P >= CDP && P < NH) ||
                                      (name === 'NL' && P >= NL && P < CDP) ||
                                      (name === 'AL' && P >= AL && P < NL) || 
                                      (name === 'AL' && P < AL && name === 'AL');
                
                let rowClass = "border-b border-gray-800 h-10 transition-all group hover:bg-gray-800/30";
                let valClass = "text-gray-400 font-medium";
                let posText = "";
                
                // Active State Styling
                if (isCurrentZone) {
                    rowClass = "bg-gray-800/80 border-l-4 border-yellow-500 h-12 shadow-sm";
                    valClass = "text-white font-bold text-lg";
                    posText = `<span class="text-yellow-500 text-[10px] font-bold bg-yellow-500/10 px-2 py-0.5 rounded">â—€ ç¾åƒ¹å€é–“</span>`;
                }

                // Check for exact test
                if (Math.abs(P - val) < (val * 0.003)) {
                     posText = `<span class="text-red-400 text-[10px] font-bold bg-red-500/10 px-2 py-0.5 rounded animate-pulse">âš¡ æ¸¬è©¦ä¸­</span>`;
                     valClass = "text-yellow-400 font-bold text-lg";
                }

                let nameColor = "text-gray-500";
                if(name==='CDP') nameColor = isCurrentZone ? "text-yellow-300" : "text-yellow-600";
                if(name==='AH'||name==='NH') nameColor = isCurrentZone ? "text-red-400" : "text-red-800";
                if(name==='AL'||name==='NL') nameColor = isCurrentZone ? "text-green-400" : "text-green-800";

                return `<tr class="${rowClass}">
                        <td class="pl-3 py-2">
                            <div class="font-bold ${nameColor}">${name}</div>
                            <div class="text-[10px] text-gray-600 font-normal">${label}</div>
                        </td>
                        <td class="text-right py-2 font-mono ${valClass}">${val.toFixed(2)}</td>
                        <td class="text-right py-2 pr-2">${posText}</td>
                    </tr>`;
            };

            let html = "";
            html += renderRow("AH", AH, "è¿½è²·é» / å£“åŠ›");
            html += renderRow("NH", NH, "è³£å‡ºé» / å£“åŠ›");
            html += renderRow("CDP", CDP, "å¤šç©ºåˆ†ç•Œç·š");
            html += renderRow("NL", NL, "è²·é€²é» / æ”¯æ’");
            html += renderRow("AL", AL, "åœæé» / æ”¯æ’");
            tableBody.innerHTML = html;

            // Generate Report
            const extractNum = (str, fallback) => str.match(/[\d.]+/)?.[0] || fallback;
            
            let overallLogic = "";
            if (sarSignal === "LONG" && isRedK) overallLogic = "é›™ç´…å…±æŒ¯ (è¶¨å‹¢å¤š+å¯¦é«”ç´…)ï¼Œå¼·å‹¢è²·è¨Šï¼Œå»ºè­°åå¤šæ“ä½œã€‚";
            else if (sarSignal === "SHORT" && !isRedK) overallLogic = "é›™ç¶ å…±æŒ¯ (è¶¨å‹¢ç©º+å¯¦é«”é»‘)ï¼Œå¼·å‹¢ç©ºè¨Šï¼Œå»ºè­°åç©ºæ“ä½œã€‚";
            else if (sarSignal === "LONG" && !isRedK) overallLogic = "è¶¨å‹¢åå¤šä½†æ”¶é»‘Kï¼ŒçŸ­ç·šéœ‡ç›ªï¼Œç•™æ„æ‹‰å›æ”¯æ’ã€‚";
            else if (sarSignal === "SHORT" && isRedK) overallLogic = "è¶¨å‹¢åç©ºä½†æ”¶ç´…Kï¼ŒçŸ­ç·šåå½ˆï¼Œç•™æ„ä¸Šæ–¹å£“åŠ›ã€‚";

            const script = `ã€çŸ³é ­ç²åˆ©åˆ†ææˆ°æ³•ã€‘${StockName} æ¥µé€Ÿæˆ°å ± (${dateStr})
åˆ†ææ¨™çš„ï¼š${StockName}

ä¸€ã€é—œéµé»ä½
ç¾åƒ¹ï¼š${P.toFixed(2)} (é–‹ç›¤ï¼š${Open.toFixed(2)})
å¤šç©ºåˆ†ç•Œ (CDP)ï¼š${CDP.toFixed(2)}
ä¸Šæ–¹å£“åŠ› (NH)ï¼š${NH.toFixed(2)}
ä¸‹æ–¹æ”¯æ’ (NL)ï¼š${NL.toFixed(2)}

äºŒã€æƒ…å‹¢åˆ¤è®€
ç›®å‰ç‹€æ…‹ï¼š${trend}
${trendDesc}

ä¸‰ã€é€²å‡ºå ´ç­–ç•¥
1. åå¤šæ“ä½œï¼šè‹¥å›æ¸¬ ${extractNum(buySuggest, 'æ”¯æ’')} ä¸ç ´ï¼Œå¯è€ƒæ…®é€²å ´ã€‚
2. åç©ºæ“ä½œï¼šè‹¥åå½ˆè‡³ ${extractNum(sellSuggest, 'å£“åŠ›')} ç„¡æ³•çªç ´ï¼Œå»ºè­°æ¸›ç¢¼ã€‚

å››ã€çŸ³é ­æˆ°æ³•ç¶œåˆè¨ºæ–·
â— SAR è¨Šè™Ÿï¼š${sarSignal} (é˜²å®ˆ: ${sarVal.toFixed(2)})
â— K æ£’å¯¦é«”ï¼š${isRedK ? "ç´…K (å¤šæ–¹)" : (P<Open ? "é»‘K (ç©ºæ–¹)" : "åå­—ç·š")}
â— ç¶œåˆç ”åˆ¤ï¼š${overallLogic}

äº”ã€çµè«–
ã€Œ${StockName} ${strategyText}ã€`;

            document.getElementById('outputScript').value = script;
        }

        // Copy Function
        function copyScript() {
            const copyText = document.getElementById("outputScript");
            if(!copyText.value) return;
            
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            
            // Visual Feedback Helper
            const btn = document.getElementById("copyBtn");
            const originalHTML = btn.innerHTML;
            const successHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> å·²è¤‡è£½`;
            
            const showSuccess = () => {
                btn.innerHTML = successHTML;
                btn.classList.remove('bg-gray-800', 'text-gray-300', 'border-gray-600');
                btn.classList.add('bg-green-600', 'text-white', 'border-green-500');
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.add('bg-gray-800', 'text-gray-300', 'border-gray-600');
                    btn.classList.remove('bg-green-600', 'text-white', 'border-green-500');
                }, 2000);
            };

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(copyText.value).then(showSuccess).catch(() => {
                    document.execCommand("copy");
                    showSuccess();
                });
            } else {
                document.execCommand("copy");
                showSuccess();
            }
        }
    </script>
</body>
</html>

